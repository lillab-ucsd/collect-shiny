[{"name":"app.R","content":"library(shiny)\nlibrary(tidyverse)\nlibrary(here)\nlibrary(ggforce)\nlibrary(ggrepel)\nlibrary(reactable)\n\n# Source helper and module files\nsource(\"R/helpers.R\")\nsource(\"R/top_items_proportion.R\")\nsource(\"R/top_items_table.R\")\nsource(\"R/age_comparison.R\")\nsource(\"R/age_bin_comparison.R\")\nsource(\"R/alignment.R\")\nsource(\"R/interest.R\")\n\nchecklist_data <- read_csv(here(\"data/collect_v1_filtered_checklist.csv\"))\nfreelist_data <- read_csv(here(\"data/collect_v1_filtered_freelist.csv\"))\n\nui <- navbarPage(\n  title = \"Collect Data Explorer\",\n  \n  top_items_proportion_ui(\"top_items_proportion\"),\n  top_items_table_ui(\"top_items_table\"),\n  age_comparison_ui(\"age_compare\"),\n  age_bin_comparison_ui(\"age_bin\"),\n  alignment_ui(\"alignment\"),\n  interest_ui(\"interest\")\n  \n)\n\nserver <- function(input, output, session) {\n  \n  top_items_proportion_server(\"top_items_proportion\", checklist_data)\n  top_items_table_server(\"top_items_table\", checklist_data)\n  age_comparison_server(\"age_compare\", checklist_data)\n  age_bin_comparison_server(\"age_bin\", checklist_data)\n  alignment_server(\"alignment\", checklist_data)\n  interest_server(\"interest\", freelist_data)\n  \n}\n\nshinyApp(ui, server)\n\n","type":"text"},{"name":"R/age_bin_comparison.R","content":"# ============================================================================\n# FILE: R/age_bin_comparison.R\n# PURPOSE: Age trend comparison using age bins to reduce noise\n# DESCRIPTION: Compare two items across age groups (bins) with options to \n#              view boys, girls, or both, showing clearer developmental trends\n# ============================================================================\n\nage_bin_comparison_ui <- function(id) {\n  ns <- NS(id)\n  \n  tabPanel(\"Age Bin Comparison\",\n           sidebarLayout(\n             sidebarPanel(\n               selectInput(ns(\"bin_item1\"), \"Select Item 1:\", choices = NULL),\n               selectInput(ns(\"bin_item2\"), \"Select Item 2:\", choices = NULL),\n               checkboxGroupInput(\n                 ns(\"gender_filter\"),\n                 \"Gender:\",\n                 choices = c(\"boy\", \"girl\"),\n                 selected = c(\"boy\", \"girl\")\n               ),\n               hr(),\n               helpText(\"Age bins group similar ages together to reduce noise in the data.\")\n             ),\n             mainPanel(\n               fluidRow(\n                 column(6, plotOutput(ns(\"bin_plot1\"))),\n                 column(6, plotOutput(ns(\"bin_plot2\")))\n               )\n             )\n           ))\n}\n\nage_bin_comparison_server <- function(id, data) {\n  moduleServer(id, function(input, output, session) {\n    \n    # Update dropdown choices\n    updateSelectInput(session, \"bin_item1\",\n                      choices = sort(unique(data$clean_item_name)),\n                      selected = \"action figures\")\n    \n    updateSelectInput(session, \"bin_item2\",\n                      choices = sort(unique(data$clean_item_name)),\n                      selected = \"animal figurines\")\n    \n    # Color palette\n    gender_colors <- c(\"girl\" = \"#C06C84\", \"boy\" = \"#0D677C\")\n    \n    # Compute summary for item 1\n    summary1 <- reactive({\n      compute_age_bin_summary(data, input$bin_item1, input$gender_filter)\n    })\n    \n    # Compute summary for item 2\n    summary2 <- reactive({\n      compute_age_bin_summary(data, input$bin_item2, input$gender_filter)\n    })\n    \n    # Plot for item 1\n    output$bin_plot1 <- renderPlot({\n      req(nrow(summary1()) > 0)\n      plot_age_bin_trend(summary1(), input$bin_item1, gender_colors, input$gender_filter)\n    })\n    \n    # Plot for item 2\n    output$bin_plot2 <- renderPlot({\n      req(nrow(summary2()) > 0)\n      plot_age_bin_trend(summary2(), input$bin_item2, gender_colors, input$gender_filter)\n    })\n  })\n}\n\n","type":"text"},{"name":"R/age_comparison.R","content":"# ============================================================================\n# FILE: R/age_comparison.R\n# PURPOSE: Compare age trends for multiple items with enhanced visualizations\n# DESCRIPTION: Interactive age trend comparison with customizable display options,\n#              multiple item selection, and aesthetic design improvements\n# ============================================================================\n\nage_comparison_ui <- function(id) {\n  ns <- NS(id)\n  \n  tabPanel(\"Age Comparison\",\n           fluidRow(\n             # Left sidebar\n             column(3,\n                    wellPanel(\n                      style = \"background-color: #f8f9fa; border: 1px solid #dee2e6;\",\n                      h4(\"Item Selection\", style = \"font-weight: bold; color: #495057;\"),\n                      \n                      selectInput(\n                        ns(\"item_select\"),\n                        \"Select Items to Compare:\",\n                        choices = NULL,\n                        multiple = TRUE,\n                        selectize = TRUE\n                      ),\n                      \n                      helpText(\"Select up to 4 items to compare\"),\n                      \n                      hr(),\n                      \n                      h4(\"Display Options\", style = \"font-weight: bold; color: #495057;\"),\n                      \n                      checkboxGroupInput(\n                        ns(\"gender_filter\"),\n                        \"Gender:\",\n                        choices = c(\"boy\", \"girl\"),\n                        selected = c(\"boy\", \"girl\")\n                      ),\n                      \n                      sliderInput(\n                        ns(\"age_range\"),\n                        \"Age Range:\",\n                        min = 1,\n                        max = 18,\n                        value = c(1, 18),\n                        step = 1\n                      ),\n                      \n                      radioButtons(\n                        ns(\"view_mode\"),\n                        \"View Mode:\",\n                        choices = c(\n                          \"Facet by Item\" = \"facet_item\",\n                          \"Facet by Gender\" = \"facet_gender\"\n                        ),\n                        selected = \"facet_item\"\n                      ),\n                      \n                      sliderInput(\n                        ns(\"line_size\"),\n                        \"Line Thickness:\",\n                        min = 0.5,\n                        max = 3,\n                        value = 1.2,\n                        step = 0.1\n                      )\n                    )\n             ),\n             \n             # Main plot area\n             column(9,\n                    wellPanel(\n                      style = \"background-color: white; border: 1px solid #dee2e6;\",\n                      plotOutput(ns(\"trend_plot\"), height = \"600px\")\n                    ),\n                    \n                    # Summary statistics\n                    wellPanel(\n                      style = \"background-color: #f8f9fa; border: 1px solid #dee2e6;\",\n                      h4(\"Summary Statistics\", style = \"font-weight: bold; color: #495057;\"),\n                      tableOutput(ns(\"summary_table\"))\n                    )\n             )\n           ))\n}\n\nage_comparison_server <- function(id, data) {\n  moduleServer(id, function(input, output, session) {\n    \n    # Update item choices and age range based on data\n    observe({\n      items <- sort(unique(data$clean_item_name))\n      updateSelectInput(\n        session,\n        \"item_select\",\n        choices = items,\n        selected = items[1:2]  # Default to first 2 items\n      )\n      \n      min_age <- min(data$age_num, na.rm = TRUE)\n      max_age <- max(data$age_num, na.rm = TRUE)\n      updateSliderInput(\n        session,\n        \"age_range\",\n        min = min_age,\n        max = max_age,\n        value = c(min_age, max_age)\n      )\n    })\n    \n    # Filter data\n    filtered_data <- reactive({\n      req(input$item_select)\n      req(length(input$gender_filter) > 0)\n      \n      data |>\n        filter(\n          clean_item_name %in% input$item_select,\n          gender_clean %in% input$gender_filter,\n          age_num >= input$age_range[1],\n          age_num <= input$age_range[2]\n        )\n    })\n    \n    # Compute age trends\n    trend_data <- reactive({\n      req(nrow(filtered_data()) > 0)\n      \n      compute_age_trends_multi(\n        filtered_data(),\n        data,\n        input$item_select,\n        input$gender_filter,\n        input$age_range\n      )\n    })\n    \n    # Render main plot\n    output$trend_plot <- renderPlot({\n      req(nrow(trend_data()) > 0)\n      \n      plot_age_trends_enhanced(\n        trend_data(),\n        view_mode = input$view_mode,\n        line_size = input$line_size,\n        selected_genders = input$gender_filter\n      )\n    })\n    \n    # Render summary table\n    output$summary_table <- renderTable({\n      req(nrow(trend_data()) > 0)\n      \n      compute_trend_summary(trend_data())\n    }, striped = TRUE, hover = TRUE, bordered = TRUE)\n  })\n}","type":"text"},{"name":"R/alignment.R","content":"# ============================================================================\n# FILE: R/alignment.R\n# PURPOSE: Alignment visualization comparing boys' vs girls' top items\n# DESCRIPTION: Slope graph showing top collected items for each gender with \n#              connecting lines for shared items, highlighting gender differences\n# ============================================================================\n\nalignment_ui <- function(id) {\n  ns <- NS(id)\n  \n  tabPanel(\"Alignment Visualization\",\n           sidebarLayout(\n             sidebarPanel(\n               sliderInput(ns(\"n_items_align\"), \"Number of Top Items to Show:\",\n                           min = 5, max = 40, value = 10, step = 1)\n             ),\n             mainPanel(\n               fluidRow(\n                 column(6, textOutput(ns(\"n_boys\"))),\n                 column(6, textOutput(ns(\"n_girls\")))\n               ),\n               plotOutput(ns(\"alignmentPlot\"), height = \"800px\")\n             )\n           ))\n}\n\nalignment_server <- function(id, data) {\n  moduleServer(id, function(input, output, session) {\n    \n    df_props <- reactive({\n      compute_gender_proportions(data)\n    })\n    \n    top_items <- reactive({\n      get_top_items_by_gender(df_props(), input$n_items_align)\n    })\n    \n    output$alignmentPlot <- renderPlot({\n      df <- top_items()\n      boys_df <- df |> filter(gender_clean == \"boy\")\n      girls_df <- df |> filter(gender_clean == \"girl\")\n      shared_df <- join_shared_items(boys_df, girls_df)\n      \n      plot_alignment(boys_df, girls_df, shared_df)\n    })\n    \n    totals <- reactive({\n      count_participants_by_gender(data)\n    })\n    \n    output$n_boys <- renderText({\n      paste0(\"n (Boys) = \",\n             totals() |> filter(gender_clean == \"boy\") |> pull(total))\n    })\n    \n    output$n_girls <- renderText({\n      paste0(\"n (Girls) = \",\n             totals() |> filter(gender_clean == \"girl\") |> pull(total))\n    })\n  })\n}\n","type":"text"},{"name":"R/helpers.R","content":"# ============================================================================\n# FILE: R/helpers.R\n# PURPOSE: Core helper functions for data processing, summarization, and plotting\n# DESCRIPTION: Contains reusable functions for filtering data, computing \n#              summaries, and creating visualizations\n# ============================================================================\n\n# ============================================================================\n# SHARED FUNCTIONS - Used across multiple tabs\n# ============================================================================\n\n# Filter checklist data by gender and age range\n# Used by: Top Items Proportion, Top Items Table, Age Bin Comparison\nfilter_checklist <- function(data, genders, age_range) {\n  data |>\n    filter(\n      gender_clean %in% genders,\n      age_num >= age_range[1],\n      age_num <= age_range[2]\n    )\n}\n\n# Count participants by item and calculate percentages\n# Used by: Top Items Proportion, Top Items Table\ncount_by_item <- function(data) {\n  total_participants <- data |> distinct(participant_id) |> nrow()\n  \n  data |>\n    group_by(clean_item_name) |>\n    summarize(count = n_distinct(participant_id), .groups = \"drop\") |>\n    mutate(percent = count / total_participants)\n}\n\n# ============================================================================\n# TOP ITEMS PROPORTION - Functions for top_items_proportion.R\n# ============================================================================\n\n# Plot top items with single color\nplot_top_items <- function(df) {\n  ggplot(df, aes(x = reorder(clean_item_name, percent), y = percent)) +\n    geom_col(fill = \"#4A90E2\", width = 0.7, alpha = 0.9) +\n    coord_flip() +\n    labs(\n      x = NULL,\n      y = \"Proportion of Participants\",\n      title = \"Top Collected Items\"\n    ) +\n    scale_y_continuous(\n      labels = scales::percent_format(accuracy = 1),\n      expand = expansion(mult = c(0, 0.05))\n    ) +\n    theme_minimal(base_size = 14) +\n    theme(\n      plot.title = element_text(face = \"bold\", size = 16, hjust = 0.5, margin = margin(b = 15)),\n      panel.grid.major.y = element_blank(),\n      panel.grid.minor = element_blank(),\n      panel.grid.major.x = element_line(color = \"gray90\"),\n      axis.text.y = element_text(size = 12, color = \"gray20\"),\n      axis.text.x = element_text(size = 11),\n      axis.title.x = element_text(face = \"bold\", size = 12, margin = margin(t = 10)),\n      plot.background = element_rect(fill = \"white\", color = NA),\n      panel.background = element_rect(fill = \"gray98\", color = NA)\n    )\n}\n\n# Plot top items colored by gender (side-by-side bars)\nplot_top_items_by_gender <- function(data, n_items) {\n  \n  gender_colors <- c(\"girl\" = \"#C06C84\", \"boy\" = \"#0D677C\")\n  \n  # Get total participants per gender\n  totals <- data |>\n    group_by(gender_clean) |>\n    summarize(total = n_distinct(participant_id), .groups = \"drop\")\n  \n  # Calculate proportions by gender\n  summary_by_gender <- data |>\n    group_by(clean_item_name, gender_clean) |>\n    summarize(count = n_distinct(participant_id), .groups = \"drop\") |>\n    left_join(totals, by = \"gender_clean\") |>\n    mutate(percent = count / total)\n  \n  # Get top N items overall (regardless of gender)\n  top_items <- data |>\n    count_by_item() |>\n    slice_max(percent, n = n_items) |>\n    pull(clean_item_name)\n  \n  # Filter to just those top items\n  plot_data <- summary_by_gender |>\n    filter(clean_item_name %in% top_items)\n  \n  # Create plot\n  ggplot(plot_data, aes(x = reorder(clean_item_name, percent), y = percent, fill = gender_clean)) +\n    geom_col(position = \"dodge\", width = 0.7, alpha = 0.9) +\n    coord_flip() +\n    scale_fill_manual(values = gender_colors, name = \"Gender\") +\n    labs(\n      x = NULL,\n      y = \"Proportion of Participants\",\n      title = \"Top Collected Items by Gender\"\n    ) +\n    scale_y_continuous(\n      labels = scales::percent_format(accuracy = 1),\n      expand = expansion(mult = c(0, 0.05))\n    ) +\n    theme_minimal(base_size = 14) +\n    theme(\n      legend.position = \"bottom\",\n      legend.title = element_text(face = \"bold\", size = 12),\n      legend.text = element_text(size = 11),\n      plot.title = element_text(face = \"bold\", size = 16, hjust = 0.5, margin = margin(b = 15)),\n      panel.grid.major.y = element_blank(),\n      panel.grid.minor = element_blank(),\n      panel.grid.major.x = element_line(color = \"gray90\"),\n      axis.text.y = element_text(size = 12, color = \"gray20\"),\n      axis.text.x = element_text(size = 11),\n      axis.title.x = element_text(face = \"bold\", size = 12, margin = margin(t = 10)),\n      plot.background = element_rect(fill = \"white\", color = NA),\n      panel.background = element_rect(fill = \"gray98\", color = NA)\n    )\n}\n\n# ============================================================================\n# TOP ITEMS TABLE - Functions for top_items_table.R\n# ============================================================================\n\n# Compute top items by gender with rank, count, and percent\ncompute_top_items_by_gender <- function(data, n_items) {\n  data |>\n    group_by(gender_clean) |>\n    mutate(total = n_distinct(participant_id)) |>\n    group_by(gender_clean, clean_item_name, total) |>\n    summarize(count = n_distinct(participant_id), .groups = \"drop\") |>\n    mutate(percent = count / total) |>\n    group_by(gender_clean) |>\n    slice_max(order_by = count, n = n_items, with_ties = FALSE) |>\n    arrange(gender_clean, desc(count)) |>\n    group_by(gender_clean) |>\n    mutate(rank = row_number()) |>\n    ungroup()\n}\n\n# Create reactable for single gender\ncreate_top_items_table <- function(data, color) {\n  reactable(\n    data |> select(rank, clean_item_name, count, percent),\n    columns = list(\n      rank = colDef(\n        name = \"Rank\",\n        width = 60,\n        style = list(fontWeight = \"bold\")\n      ),\n      clean_item_name = colDef(\n        name = \"Item\",\n        minWidth = 150\n      ),\n      count = colDef(\n        name = \"Count\",\n        width = 80,\n        style = function(value) {\n          list(fontWeight = \"600\", color = color)\n        }\n      ),\n      percent = colDef(\n        name = \"Percent\",\n        width = 100,\n        format = colFormat(percent = TRUE, digits = 1),\n        style = function(value) {\n          list(\n            background = paste0(color, \"20\"),\n            borderLeft = paste0(\"4px solid \", color)\n          )\n        }\n      )\n    ),\n    defaultPageSize = 20,\n    striped = TRUE,\n    highlight = TRUE,\n    bordered = TRUE,\n    style = list(fontSize = \"14px\")\n  )\n}\n\n# Create combined table with both genders side-by-side\ncreate_combined_table <- function(data) {\n  \n  # Pivot to wide format\n  wide_data <- data |>\n    select(rank, gender_clean, clean_item_name, count, percent) |>\n    pivot_wider(\n      names_from = gender_clean,\n      values_from = c(clean_item_name, count, percent),\n      names_glue = \"{gender_clean}_{.value}\"\n    ) |>\n    select(\n      rank,\n      boy_clean_item_name, boy_count, boy_percent,\n      girl_clean_item_name, girl_count, girl_percent\n    )\n  \n  reactable(\n    wide_data,\n    columns = list(\n      rank = colDef(\n        name = \"Rank\",\n        width = 60,\n        style = list(fontWeight = \"bold\", textAlign = \"center\")\n      ),\n      boy_clean_item_name = colDef(\n        name = \"Item\",\n        minWidth = 150,\n        header = function() {\n          div(style = \"color: #0D677C; font-weight: bold;\", \"Boys - Item\")\n        }\n      ),\n      boy_count = colDef(\n        name = \"Count\",\n        width = 80,\n        style = list(color = \"#0D677C\", fontWeight = \"600\"),\n        header = function() {\n          div(style = \"color: #0D677C; font-weight: bold;\", \"Count\")\n        }\n      ),\n      boy_percent = colDef(\n        name = \"Percent\",\n        width = 100,\n        format = colFormat(percent = TRUE, digits = 1),\n        style = function(value) {\n          list(\n            background = \"#0D677C20\",\n            borderLeft = \"4px solid #0D677C\"\n          )\n        },\n        header = function() {\n          div(style = \"color: #0D677C; font-weight: bold;\", \"Percent\")\n        }\n      ),\n      girl_clean_item_name = colDef(\n        name = \"Item\",\n        minWidth = 150,\n        header = function() {\n          div(style = \"color: #C06C84; font-weight: bold;\", \"Girls - Item\")\n        }\n      ),\n      girl_count = colDef(\n        name = \"Count\",\n        width = 80,\n        style = list(color = \"#C06C84\", fontWeight = \"600\"),\n        header = function() {\n          div(style = \"color: #C06C84; font-weight: bold;\", \"Count\")\n        }\n      ),\n      girl_percent = colDef(\n        name = \"Percent\",\n        width = 100,\n        format = colFormat(percent = TRUE, digits = 1),\n        style = function(value) {\n          list(\n            background = \"#C06C8420\",\n            borderLeft = \"4px solid #C06C84\"\n          )\n        },\n        header = function() {\n          div(style = \"color: #C06C84; font-weight: bold;\", \"Percent\")\n        }\n      )\n    ),\n    columnGroups = list(\n      colGroup(name = \"Boys\", columns = c(\"boy_clean_item_name\", \"boy_count\", \"boy_percent\"),\n               headerStyle = list(background = \"#0D677C20\", fontWeight = \"bold\")),\n      colGroup(name = \"Girls\", columns = c(\"girl_clean_item_name\", \"girl_count\", \"girl_percent\"),\n               headerStyle = list(background = \"#C06C8420\", fontWeight = \"bold\"))\n    ),\n    defaultPageSize = 20,\n    striped = TRUE,\n    highlight = TRUE,\n    bordered = TRUE,\n    style = list(fontSize = \"14px\")\n  )\n}\n\n# ============================================================================\n# AGE COMPARISON - Functions for age_comparison.R\n# ============================================================================\n\n# Compute age trends for multiple items\ncompute_age_trends_multi <- function(filtered_data, full_data, items, genders, age_range) {\n  \n  # Get total participants per age and gender\n  totals <- full_data |>\n    filter(\n      gender_clean %in% genders,\n      age_num >= age_range[1],\n      age_num <= age_range[2]\n    ) |>\n    group_by(age_num, gender_clean) |>\n    summarize(total = n_distinct(participant_id), .groups = \"drop\")\n  \n  # Calculate proportions for each item\n  filtered_data |>\n    group_by(clean_item_name, age_num, gender_clean) |>\n    summarize(count = n_distinct(participant_id), .groups = \"drop\") |>\n    left_join(totals, by = c(\"age_num\", \"gender_clean\")) |>\n    mutate(percent = count / total) |>\n    filter(!is.na(percent))\n}\n\n# Enhanced age trend plotting\nplot_age_trends_enhanced <- function(df, view_mode, show_points, show_smooth, \n                                     line_size, selected_genders) {\n  \n  # Color palettes\n  gender_colors <- c(\"girl\" = \"#C06C84\", \"boy\" = \"#0D677C\")\n  item_colors <- c(\"#2A7FFF\", \"#FF6B6B\", \"#4ECDC4\", \"#FFD93D\", \"#95E1D3\", \"#F38181\")\n  \n  # Base plot\n  if (view_mode == \"facet_item\") {\n    # Facet by item\n    p <- ggplot(df, aes(x = age_num, y = percent, \n                        color = gender_clean,\n                        group = gender_clean))\n    \n  } else {\n    # Facet by gender\n    p <- ggplot(df, aes(x = age_num, y = percent, \n                        color = clean_item_name,\n                        group = clean_item_name))\n  }\n  \n  # Add lines\n  p <- p + geom_line(size = line_size, alpha = 0.8)\n  \n  # Add points\n  p <- p + geom_point(size = line_size * 1.5, alpha = 0.7)\n  \n  # Add facets if needed\n  if (view_mode == \"facet_item\") {\n    p <- p + facet_wrap(~clean_item_name, ncol = 2)\n  } else if (view_mode == \"facet_gender\") {\n    p <- p + facet_wrap(~gender_clean, ncol = 2)\n  }\n  \n  # Theme and labels\n  p <- p +\n    labs(\n      title = \"Age Trends Comparison\",\n      x = \"Age\",\n      y = \"Proportion of Participants\"\n    ) +\n    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +\n    scale_x_continuous(breaks = seq(0, 20, 2)) +\n    theme_minimal(base_size = 14) +\n    theme(\n      plot.title = element_text(face = \"bold\", size = 18, hjust = 0.5, margin = margin(b = 15)),\n      legend.position = \"bottom\",\n      legend.title = element_text(face = \"bold\", size = 12),\n      legend.text = element_text(size = 11),\n      panel.grid.minor = element_blank(),\n      panel.grid.major = element_line(color = \"gray90\"),\n      plot.background = element_rect(fill = \"white\", color = NA),\n      panel.background = element_rect(fill = \"gray98\", color = NA),\n      strip.text = element_text(face = \"bold\", size = 12),\n      strip.background = element_rect(fill = \"gray90\", color = NA)\n    )\n  \n  return(p)\n}\n\n# Compute summary statistics for trends\ncompute_trend_summary <- function(df) {\n  df |>\n    group_by(clean_item_name, gender_clean) |>\n    summarize(\n      `Min Age` = min(age_num, na.rm = TRUE),\n      `Max Age` = max(age_num, na.rm = TRUE),\n      `Avg Proportion` = scales::percent(mean(percent, na.rm = TRUE), accuracy = 0.1),\n      `Peak Age` = age_num[which.max(percent)],\n      `Peak Proportion` = scales::percent(max(percent, na.rm = TRUE), accuracy = 0.1),\n      `Sample Size` = sum(count, na.rm = TRUE),\n      .groups = \"drop\"\n    ) |>\n    rename(\n      Item = clean_item_name,\n      Gender = gender_clean\n    )\n}\n\n# ============================================================================\n# AGE BIN COMPARISON - Functions for age_bin_comparison.R\n# ============================================================================\n\n# Compute age bin summary (groups ages into bins to reduce noise)\ncompute_age_bin_summary <- function(data, item_name, genders) {\n  \n  # Filter by item and gender\n  item_data <- data |>\n    filter(\n      clean_item_name == item_name,\n      gender_clean %in% genders\n    )\n  \n  # Get total participants per age bin and gender\n  total_per_bin <- data |>\n    filter(gender_clean %in% genders) |>\n    group_by(age_bin, gender_clean) |>\n    summarize(total = n_distinct(participant_id), .groups = \"drop\")\n  \n  # Calculate proportions\n  result <- item_data |>\n    group_by(age_bin, gender_clean) |>\n    summarize(count = n_distinct(participant_id), .groups = \"drop\") |>\n    left_join(total_per_bin, by = c(\"age_bin\", \"gender_clean\")) |>\n    mutate(percent = count / total) |>\n    filter(!is.na(age_bin))\n  \n  # Get unique age bins and sort them by the starting age number\n  age_bin_order <- result |>\n    distinct(age_bin) |>\n    mutate(start_age = as.numeric(str_extract(age_bin, \"\\\\d+\"))) |>\n    arrange(start_age) |>\n    pull(age_bin)\n  \n  # Convert age_bin to ordered factor\n  result |>\n    mutate(age_bin = factor(age_bin, levels = age_bin_order))\n}\n\n# Plot age bin trends (single plot, can show one or both genders)\nplot_age_bin_trend <- function(df, item_name, gender_colors, selected_genders) {\n  \n  # If both genders selected, show lines for each\n  if (length(selected_genders) == 2) {\n    p <- ggplot(df, aes(x = age_bin, y = percent, color = gender_clean, group = gender_clean)) +\n      geom_line(size = 1.2) +\n      geom_point(size = 3) +\n      scale_color_manual(values = gender_colors, name = \"Gender\")\n    \n    # If one gender, show single line\n  } else {\n    color_val <- gender_colors[selected_genders]\n    p <- ggplot(df, aes(x = age_bin, y = percent, group = 1)) +\n      geom_line(size = 1.2, color = color_val) +\n      geom_point(size = 3, color = color_val)\n  }\n  \n  # Add common elements\n  p <- p +\n    labs(\n      title = paste(\"Age Bin Trends for:\", item_name),\n      x = \"Age Group\", \n      y = \"Proportion\"\n    ) +\n    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +\n    scale_x_discrete(labels = function(x) str_replace(x, \" to \", \"-\")) +\n    theme_minimal(base_size = 14) +\n    theme(\n      axis.text.x = element_text(angle = 45, hjust = 1),\n      legend.position = \"bottom\"\n    )\n  \n  return(p)\n}\n\n# Alternative: Plot age bin trends with faceted panels by gender\nplot_age_bin_trend_faceted <- function(df, item_name) {\n  ggplot(df, aes(x = age_bin, y = percent, group = 1)) +\n    geom_line(size = 1.2, color = \"#2A7FFF\") +\n    geom_point(size = 3, color = \"#2A7FFF\") +\n    facet_wrap(~gender_clean, ncol = 2) +\n    labs(\n      title = paste(\"Age Bin Trends for:\", item_name),\n      x = \"Age Bin\",\n      y = \"Proportion\"\n    ) +\n    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +\n    theme_minimal(base_size = 14) +\n    theme(\n      axis.text.x = element_text(angle = 45, hjust = 1),\n      strip.text = element_text(size = 12, face = \"bold\")\n    )\n}\n\n# ============================================================================\n# ALIGNMENT - Functions for alignment.R\n# ============================================================================\n\n# Compute gender proportions for alignment visualization\ncompute_gender_proportions <- function(data) {\n  data |>\n    group_by(gender_clean, clean_item_name) |>\n    summarize(count = n(), .groups = \"drop\") |>\n    group_by(gender_clean) |>\n    mutate(proportion = count / sum(count)) |>\n    ungroup()\n}\n\n# Get top N items for each gender\nget_top_items_by_gender <- function(df, n) {\n  df |>\n    group_by(gender_clean) |>\n    slice_max(order_by = proportion, n = n, with_ties = FALSE) |>\n    ungroup()\n}\n\n# Join boys and girls data to find shared items\njoin_shared_items <- function(boys_df, girls_df) {\n  inner_join(\n    boys_df |> select(clean_item_name, prop_boy = proportion),\n    girls_df |> select(clean_item_name, prop_girl = proportion),\n    by = \"clean_item_name\"\n  )\n}\n\n# Count total participants by gender\ncount_participants_by_gender <- function(data) {\n  data |>\n    group_by(gender_clean) |>\n    summarize(total = n_distinct(participant_id), .groups = \"drop\")\n}\n\n# Plot alignment visualization (slope graph)\nplot_alignment <- function(boys_df, girls_df, shared_df) {\n  \n  ggplot() +\n    geom_segment(\n      data = shared_df,\n      aes(x = 1, xend = 2, y = prop_boy, yend = prop_girl),\n      color = \"gray60\"\n    ) +\n    geom_point(\n      data = boys_df,\n      aes(x = 1, y = proportion, size = proportion),\n      color = \"#0D677C\", alpha = 0.8\n    ) +\n    geom_text_repel(\n      data = boys_df,\n      aes(x = 1, y = proportion, label = paste0(clean_item_name, \" (\", round(proportion*100,1), \"%)\")),\n      nudge_x = -0.1,\n      direction = \"y\",\n      hjust = 1,\n      size = 3.5,\n      color = \"#0D677C\",\n      segment.color = NA\n    ) +\n    geom_point(\n      data = girls_df,\n      aes(x = 2, y = proportion, size = proportion),\n      color = \"#C06C84\", alpha = 0.8\n    ) +\n    geom_text_repel(\n      data = girls_df,\n      aes(x = 2, y = proportion, label = paste0(clean_item_name, \" (\", round(proportion*100,1), \"%)\")),\n      nudge_x = 0.1,\n      direction = \"y\",\n      hjust = 0,\n      size = 3.5,\n      color = \"#C06C84\",\n      segment.color = NA\n    ) +\n    scale_x_continuous(\n      limits = c(0.5, 2.5),\n      breaks = c(1, 2),\n      labels = c(\"Boys\", \"Girls\")\n    ) +\n    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +\n    labs(x = NULL, y = \"Proportion of Participants\", size = \"Proportion\") +\n    theme_minimal(base_size = 14) +\n    theme(\n      axis.text.y = element_blank(),\n      panel.grid = element_blank(),\n      legend.position = \"bottom\"\n    )\n}\n\n# ============================================================================\n# INTEREST - Functions for interest.R (freelist data)\n# ============================================================================\n\n# Compute interest summary across four dimensions\ncompute_interest_summary <- function(data, collection_name, genders, age_range) {\n  data |>\n    filter(\n      collection_name_matched == collection_name,\n      gender_clean %in% genders,\n      age_num >= age_range[1],\n      age_num <= age_range[2]\n    ) |>\n    select(interest_learning, interest_curious, interest_talking, interest_playing) |>\n    summarise(\n      Learning = mean(interest_learning, na.rm = TRUE),\n      Curious = mean(interest_curious, na.rm = TRUE),\n      Talking = mean(interest_talking, na.rm = TRUE),\n      Playing = mean(interest_playing, na.rm = TRUE),\n      n = n()\n    ) |>\n    pivot_longer(\n      cols = c(Learning, Curious, Talking, Playing),\n      names_to = \"dimension\",\n      values_to = \"mean_score\"\n    )\n}\n\n# Plot interest profile line chart\nplot_interest_profile <- function(summary_df, collection_name) {\n  ggplot(summary_df, aes(x = dimension, y = mean_score, group = 1)) +\n    geom_line(size = 1.2, color = \"#2A7FFF\") +\n    geom_point(size = 4, color = \"#2A7FFF\") +\n    scale_y_continuous(limits = c(1, 7), breaks = 1:7) +\n    labs(\n      x = NULL,\n      y = \"Mean Agreement (1â€“7)\",\n      title = paste(\"Interest Profile for:\", collection_name)\n    ) +\n    theme_minimal(base_size = 14)\n}","type":"text"},{"name":"R/interest.R","content":"# ============================================================================\n# FILE: R/interest.R\n# PURPOSE: Interest profile visualization for freelist collections\n# DESCRIPTION: Line plot showing mean interest ratings across four dimensions \n#              (learning, curious, talking, playing) for selected collections\n# ============================================================================\n\ninterest_ui <- function(id) {\n  ns <- NS(id)\n  \n  tabPanel(\n    \"Interest Profiles\",\n    sidebarLayout(\n      sidebarPanel(\n        selectInput(ns(\"collection\"), \"Select Collection:\", choices = NULL),\n        sliderInput(ns(\"age_range\"), \"Age Range:\", \n                    min = 1, max = 18, value = c(1, 18)),\n        checkboxGroupInput(\n          ns(\"gender\"),\n          \"Gender:\",\n          choices = c(\"boy\", \"girl\"),\n          selected = c(\"boy\", \"girl\")\n        ),\n        hr(),\n        textOutput(ns(\"sample_size\"))\n      ),\n      mainPanel(\n        plotOutput(ns(\"interest_plot\"), height = \"400px\")\n      )\n    )\n  )\n}\n\ninterest_server <- function(id, freelist_long_data) {\n  moduleServer(id, function(input, output, session) {\n    \n    # Update UI inputs based on data\n    observe({\n      collections <- freelist_long_data |>\n        filter(!is.na(collection_name_matched)) |>\n        pull(collection_name_matched) |>\n        unique() |>\n        sort()\n      \n      updateSelectInput(\n        session,\n        \"collection\",\n        choices = collections,\n        selected = collections[1]\n      )\n      \n      updateSliderInput(\n        session,\n        \"age_range\",\n        min = min(freelist_long_data$age_num, na.rm = TRUE),\n        max = max(freelist_long_data$age_num, na.rm = TRUE),\n        value = c(min(freelist_long_data$age_num, na.rm = TRUE), \n                  max(freelist_long_data$age_num, na.rm = TRUE))\n      )\n    })\n    \n    # Compute summary statistics\n    summary <- reactive({\n      req(input$collection)\n      compute_interest_summary(\n        freelist_long_data,\n        input$collection,\n        input$gender,\n        input$age_range\n      )\n    })\n    \n    # Display sample size\n    output$sample_size <- renderText({\n      n <- summary() |> pull(n) |> first()\n      paste0(\"Sample size: n = \", n)\n    })\n    \n    # Render plot\n    output$interest_plot <- renderPlot({\n      req(nrow(summary()) > 0)\n      plot_interest_profile(summary(), input$collection)\n    })\n  })\n}","type":"text"},{"name":"R/top_items_proportion.R","content":"# ============================================================================\n# FILE: R/top_items_proportion.R\n# PURPOSE: Bar chart showing proportion of participants with top items\n# DESCRIPTION: Visualize most commonly collected items with filters for \n#              gender and age\n# ============================================================================\n\ntop_items_proportion_ui <- function(id) {\n  ns <- NS(id)\n  \n  tabPanel(\"Top Items Proportion\",\n           sidebarLayout(\n             sidebarPanel(\n               checkboxGroupInput(\n                 ns(\"gender_filter\"),\n                 \"Select Gender:\",\n                 choices = c(\"boy\", \"girl\"),\n                 selected = c(\"boy\", \"girl\")\n               ),\n               sliderInput(\n                 ns(\"age_range\"),\n                 \"Select Age Range:\",\n                 min = 1,\n                 max = 100,\n                 value = c(1, 100),\n                 step = 1\n               ),\n               sliderInput(\n                 ns(\"top_n\"),\n                 \"Top N items to show:\",\n                 min = 5,\n                 max = 40,\n                 value = 10,\n                 step = 1\n               ),\n               hr(),\n               radioButtons(\n                 ns(\"color_by\"),\n                 \"Color bars by:\",\n                 choices = c(\n                   \"Single Color\" = \"single\",\n                   \"By Gender\" = \"gender\"\n                 ),\n                 selected = \"single\"\n               ),\n               hr(),\n               helpText(\"Shows the proportion of participants who collect each item.\")\n             ),\n             mainPanel(\n               plotOutput(ns(\"bar_plot\"), height = \"600px\")\n             )\n           ))\n}\n\ntop_items_proportion_server <- function(id, data) {\n  moduleServer(id, function(input, output, session) {\n    \n    # Update age range slider based on actual data\n    observe({\n      min_age <- min(data$age_num, na.rm = TRUE)\n      max_age <- max(data$age_num, na.rm = TRUE)\n      updateSliderInput(\n        session,\n        \"age_range\",\n        min = min_age,\n        max = max_age,\n        value = c(min_age, max_age)\n      )\n    })\n    \n    # Filter data based on user selections\n    filtered <- reactive({\n      filter_checklist(data, input$gender_filter, input$age_range)\n    })\n    \n    # Compute summary statistics\n    summary <- reactive({\n      filtered() |>\n        count_by_item() |>\n        slice_max(percent, n = input$top_n)\n    })\n    \n    # Render plot\n    output$bar_plot <- renderPlot({\n      req(nrow(summary()) > 0)\n      \n      if (input$color_by == \"gender\") {\n        plot_top_items_by_gender(filtered(), input$top_n)\n      } else {\n        plot_top_items(summary())\n      }\n    })\n  })\n}","type":"text"},{"name":"R/top_items_table.R","content":"# ============================================================================\n# FILE: R/top_items_table.R\n# PURPOSE: Interactive table showing top collected items by gender\n# DESCRIPTION: Sortable, filterable reactable displaying top items with \n#              side-by-side or combined view, showing rank, count, and percent\n# ============================================================================\n\ntop_items_table_ui <- function(id) {\n  ns <- NS(id)\n  \n  tabPanel(\"Top Items Table\",\n           sidebarLayout(\n             sidebarPanel(\n               sliderInput(\n                 ns(\"n_items\"),\n                 \"Number of Top Items to Show:\",\n                 min = 5,\n                 max = 50,\n                 value = 10,\n                 step = 5\n               ),\n               sliderInput(\n                 ns(\"age_range\"),\n                 \"Age Range:\",\n                 min = 1,\n                 max = 18,\n                 value = c(1, 18),\n                 step = 1\n               ),\n               checkboxGroupInput(\n                 ns(\"gender_filter\"),\n                 \"Gender:\",\n                 choices = c(\"boy\", \"girl\"),\n                 selected = c(\"boy\", \"girl\")\n               ),\n               hr(),\n               radioButtons(\n                 ns(\"view_type\"),\n                 \"View Type:\",\n                 choices = c(\n                   \"Side by Side\" = \"side_by_side\",\n                   \"Combined Table\" = \"combined\"\n                 ),\n                 selected = \"side_by_side\"\n               ),\n               hr(),\n               helpText(\"Shows the most commonly collected items by gender.\")\n             ),\n             mainPanel(\n               uiOutput(ns(\"table_output\"))\n             )\n           ))\n}\n\ntop_items_table_server <- function(id, data) {\n  moduleServer(id, function(input, output, session) {\n    \n    # Update age range based on data\n    observe({\n      min_age <- min(data$age_num, na.rm = TRUE)\n      max_age <- max(data$age_num, na.rm = TRUE)\n      updateSliderInput(\n        session,\n        \"age_range\",\n        min = min_age,\n        max = max_age,\n        value = c(min_age, max_age)\n      )\n    })\n    \n    # Filter data based on selections\n    filtered_data <- reactive({\n      data |>\n        filter(\n          gender_clean %in% input$gender_filter,\n          age_num >= input$age_range[1],\n          age_num <= input$age_range[2]\n        )\n    })\n    \n    # Compute top items by gender\n    top_items_by_gender <- reactive({\n      compute_top_items_by_gender(filtered_data(), input$n_items)\n    })\n    \n    # Render appropriate view\n    output$table_output <- renderUI({\n      ns <- session$ns\n      \n      if (input$view_type == \"side_by_side\") {\n        # Side by side tables\n        boys_data <- top_items_by_gender() |> filter(gender_clean == \"boy\")\n        girls_data <- top_items_by_gender() |> filter(gender_clean == \"girl\")\n        \n        fluidRow(\n          column(\n            6,\n            h4(\"Boys\", style = \"color: #0D677C; text-align: center;\"),\n            reactableOutput(ns(\"boys_table\"))\n          ),\n          column(\n            6,\n            h4(\"Girls\", style = \"color: #C06C84; text-align: center;\"),\n            reactableOutput(ns(\"girls_table\"))\n          )\n        )\n      } else {\n        # Combined table\n        reactableOutput(ns(\"combined_table\"))\n      }\n    })\n    \n    # Boys table\n    output$boys_table <- renderReactable({\n      boys_data <- top_items_by_gender() |> filter(gender_clean == \"boy\")\n      \n      create_top_items_table(boys_data, \"#0D677C\")\n    })\n    \n    # Girls table\n    output$girls_table <- renderReactable({\n      girls_data <- top_items_by_gender() |> filter(gender_clean == \"girl\")\n      \n      create_top_items_table(girls_data, \"#C06C84\")\n    })\n    \n    # Combined table\n    output$combined_table <- renderReactable({\n      create_combined_table(top_items_by_gender())\n    })\n  })\n}\n","type":"text"}]
