[{"name":"app.R","content":"library(shiny)\nlibrary(tidyverse)\nlibrary(here)\nlibrary(ggforce)\nlibrary(ggrepel)\nlibrary(reactable)\nlibrary(ggplot2)\nlibrary(munsell)\n\n# Source helper and module files\nsource(\"R/helpers.R\")\nsource(\"R/top_items_proportion.R\")\nsource(\"R/top_items_table.R\")\nsource(\"R/age_comparison.R\")\nsource(\"R/alignment.R\")\nsource(\"R/interest.R\")\n\nchecklist_data <- read_csv(here(\"data/collect_v1_checklist_long.csv\"))\nfreelist_data <- read_csv(here(\"data/collect_v1_freelist_long.csv\"))\n\nui <- navbarPage(\n  title = \"Collect Data Explorer\",\n  \n  top_items_proportion_ui(\"top_items_proportion\"),\n  top_items_table_ui(\"top_items_table\"),\n  age_comparison_ui(\"age_compare\"),\n  alignment_ui(\"alignment\"),\n  interest_ui(\"interest\")\n  \n)\n\nserver <- function(input, output, session) {\n  \n  top_items_proportion_server(\"top_items_proportion\", checklist_data)\n  top_items_table_server(\"top_items_table\", checklist_data)\n  age_comparison_server(\"age_compare\", checklist_data)\n  alignment_server(\"alignment\", checklist_data)\n  interest_server(\"interest\", freelist_data)\n  \n}\n\nshinyApp(ui, server)\n\n","type":"text"},{"name":"R/age_comparison.R","content":"# ============================================================================\n# FILE: R/age_comparison.R\n# PURPOSE: Compare age trends for multiple items with enhanced visualizations\n# DESCRIPTION: Interactive age trend comparison with customizable display options,\n#              multiple item selection, and aesthetic design improvements\n# ============================================================================\n\nage_comparison_ui <- function(id) {\n  ns <- NS(id)\n  \n  tabPanel(\"Age Comparison\",\n           fluidRow(\n             # Left sidebar\n             column(3,\n                    wellPanel(\n                      style = \"background-color: #f8f9fa; border: 1px solid #dee2e6;\",\n                      h4(\"Item Selection\", style = \"font-weight: bold; color: #495057;\"),\n                      \n                      selectInput(\n                        ns(\"item_select\"),\n                        \"Select Items to Compare (max 4):\",\n                        choices = NULL,\n                        multiple = TRUE,\n                        selectize = TRUE\n                      ),\n                      \n                      helpText(\"Select 1-4 items to compare age trends\"),\n                      \n                      hr(),\n                      \n                      h4(\"Display Options\", style = \"font-weight: bold; color: #495057;\"),\n                      \n                      selectInput(\n                        ns(\"gender_filter\"),\n                        \"Select Gender:\",\n                        choices = c(\n                          \"Boys Only\" = \"boy\",\n                          \"Girls Only\" = \"girl\",\n                          \"Boys & Girls (Separated)\" = \"both_separate\",\n                          \"Boys & Girls (Combined)\" = \"both_combined\"\n                        ),\n                        selected = \"both_combined\"\n                      ),\n                      \n                      sliderInput(\n                        ns(\"age_range\"),\n                        \"Age Range:\",\n                        min = 1,\n                        max = 18,\n                        value = c(1, 18),\n                        step = 1\n                      ),\n                      \n                      radioButtons(\n                        ns(\"view_mode\"),\n                        \"View Mode:\",\n                        choices = c(\n                          \"All Items Together\" = \"together\",\n                          \"Separate Panel per Item\" = \"facet_item\"\n                        ),\n                        selected = \"together\"\n                      ),\n                      \n                      hr(),\n                      \n                      h5(\"Styling Options\", style = \"font-weight: bold; color: #495057;\"),\n                      \n                      checkboxInput(\n                        ns(\"show_points\"),\n                        \"Show Data Points\",\n                        value = TRUE\n                      )\n                    )\n             ),\n             \n             # Main plot area\n             column(9,\n                    wellPanel(\n                      style = \"background-color: white; border: 1px solid #dee2e6;\",\n                      plotOutput(ns(\"trend_plot\"), height = \"600px\")\n                    ),\n                    \n                    # Summary statistics\n                    wellPanel(\n                      style = \"background-color: #f8f9fa; border: 1px solid #dee2e6;\",\n                      h4(\"Summary Statistics\", style = \"font-weight: bold; color: #495057;\"),\n                      tableOutput(ns(\"summary_table\"))\n                    )\n             )\n           ))\n}\n\nage_comparison_server <- function(id, data) {\n  moduleServer(id, function(input, output, session) {\n    \n    # Update item choices and age range based on data\n    observe({\n      items <- sort(unique(data$clean_item_name))\n      updateSelectInput(\n        session,\n        \"item_select\",\n        choices = items,\n        selected = items[1:min(2, length(items))]  # Default to first 2 items\n      )\n      \n      min_age <- min(data$age_num, na.rm = TRUE)\n      max_age <- max(data$age_num, na.rm = TRUE)\n      updateSliderInput(\n        session,\n        \"age_range\",\n        min = min_age,\n        max = max_age,\n        value = c(min_age, max_age)\n      )\n    })\n    \n    # Validate and limit item selection to 4\n    observeEvent(input$item_select, {\n      if (length(input$item_select) > 4) {\n        updateSelectInput(\n          session,\n          \"item_select\",\n          selected = input$item_select[1:4]\n        )\n        showNotification(\n          \"Maximum 4 items allowed. Keeping first 4 selections.\",\n          type = \"warning\",\n          duration = 3\n        )\n      }\n    })\n    \n    # Filter data\n    filtered_data <- reactive({\n      req(input$item_select)\n      req(length(input$item_select) > 0)\n      \n      # Parse gender selection\n      gender_info <- parse_gender_selection(input$gender_filter)\n      \n      data |>\n        filter(\n          clean_item_name %in% input$item_select,\n          gender_clean %in% gender_info$genders,\n          age_num >= input$age_range[1],\n          age_num <= input$age_range[2]\n        )\n    })\n    \n    # Compute age trends\n    trend_data <- reactive({\n      req(nrow(filtered_data()) > 0)\n      \n      gender_info <- parse_gender_selection(input$gender_filter)\n      \n      # Use different function for combined vs separated\n      if (input$gender_filter == \"both_combined\") {\n        compute_age_trends_combined(\n          filtered_data(),\n          data,\n          input$item_select,\n          input$age_range\n        )\n      } else {\n        compute_age_trends_multi(\n          filtered_data(),\n          data,\n          input$item_select,\n          gender_info$genders,\n          input$age_range\n        )\n      }\n    })\n    \n    # Render main plot\n    output$trend_plot <- renderPlot({\n      req(nrow(trend_data()) > 0)\n      \n      plot_age_trends_enhanced(\n        trend_data(),\n        view_mode = input$view_mode,\n        show_points = input$show_points,\n        gender_mode = input$gender_filter\n      )\n    })\n    \n    # Render summary table\n    output$summary_table <- renderTable({\n      req(nrow(trend_data()) > 0)\n      \n      compute_trend_summary(trend_data(), input$gender_filter)\n    }, striped = TRUE, hover = TRUE, bordered = TRUE)\n  })\n}","type":"text"},{"name":"R/alignment.R","content":"# ============================================================================\n# FILE: R/alignment.R\n# PURPOSE: Alignment visualization comparing boys' vs girls' top items\n# DESCRIPTION: Slope graph showing top collected items for each gender with \n#              connecting lines for shared items, highlighting gender differences\n# ============================================================================\n\nalignment_ui <- function(id) {\n  ns <- NS(id)\n  \n  tabPanel(\"Alignment Visualization\",\n           sidebarLayout(\n             sidebarPanel(\n               sliderInput(ns(\"n_items_align\"), \"Number of Top Items to Show:\",\n                           min = 5, max = 40, value = 10, step = 1)\n             ),\n             mainPanel(\n               plotOutput(ns(\"alignmentPlot\"), height = \"800px\")\n             )\n           ))\n}\n\nalignment_server <- function(id, data) {\n  moduleServer(id, function(input, output, session) {\n    \n    df_props <- reactive({\n      compute_gender_proportions(data)\n    })\n    \n    top_items <- reactive({\n      get_top_items_by_gender(df_props(), input$n_items_align)\n    })\n    \n    totals <- reactive({\n      count_participants_by_gender(data)\n    })\n    \n    output$alignmentPlot <- renderPlot({\n      df <- top_items()\n      boys_df <- df |> filter(gender_clean == \"boy\")\n      girls_df <- df |> filter(gender_clean == \"girl\")\n      shared_df <- join_shared_items(boys_df, girls_df)\n      \n      n_boys <- totals() |> filter(gender_clean == \"boy\") |> pull(total)\n      n_girls <- totals() |> filter(gender_clean == \"girl\") |> pull(total)\n      \n      plot_alignment_ranked(boys_df, girls_df, shared_df, n_boys, n_girls)\n    })\n  })\n}\n","type":"text"},{"name":"R/helpers.R","content":"# ============================================================================\n# FILE: R/helpers.R\n# PURPOSE: Core helper functions for data processing, summarization, and plotting\n# DESCRIPTION: Contains reusable functions for filtering data, computing \n#              summaries, and creating visualizations\n# ============================================================================\n\n# ============================================================================\n# SHARED FUNCTIONS - Used across multiple tabs\n# ============================================================================\n\n# Filter checklist data by gender and age range\n# Used by: Top Items Proportion, Top Items Table, Age Bin Comparison\nfilter_checklist <- function(data, genders, age_range) {\n  data |>\n    filter(\n      gender_clean %in% genders,\n      age_num >= age_range[1],\n      age_num <= age_range[2]\n    )\n}\n\n# Parse gender selection from dropdown\nparse_gender_selection <- function(gender_filter) {\n  if (gender_filter %in% c(\"boy\", \"girl\")) {\n    list(genders = gender_filter, separate = FALSE)\n  } else if (gender_filter == \"both_separate\") {\n    list(genders = c(\"boy\", \"girl\"), separate = TRUE)\n  } else {  # both_combined\n    list(genders = c(\"boy\", \"girl\"), separate = FALSE)\n  }\n}\n\n# Count participants by item and calculate percentages\n# Used by: Top Items Proportion, Top Items Table\ncount_by_item <- function(data) {\n  total_participants <- data |> distinct(participant_id) |> nrow()\n  \n  data |>\n    group_by(clean_item_name) |>\n    summarize(count = n_distinct(participant_id), .groups = \"drop\") |>\n    mutate(percent = count / total_participants)\n}\n\n# ============================================================================\n# TOP ITEMS PROPORTION - Functions for top_items_proportion.R\n# ============================================================================\n\n# Plot top items with single color\nplot_top_items <- function(df, title, color) {\n  ggplot(df, aes(x = reorder(clean_item_name, percent), y = percent)) +\n    geom_col(fill = color, width = 0.7, alpha = 0.9) +\n    coord_flip() +\n    labs(\n      x = NULL,\n      y = \"Proportion of Participants\",\n      title = title\n    ) +\n    scale_y_continuous(\n      labels = scales::percent_format(accuracy = 1),\n      expand = expansion(mult = c(0, 0.05))\n    ) +\n    theme_minimal(base_size = 14) +\n    theme(\n      plot.title = element_text(face = \"bold\", size = 16, hjust = 0.5, margin = margin(b = 15)),\n      panel.grid.major.y = element_blank(),\n      panel.grid.minor = element_blank(),\n      panel.grid.major.x = element_line(color = \"gray90\"),\n      axis.text.y = element_text(size = 12, color = \"gray20\"),\n      axis.text.x = element_text(size = 11),\n      axis.title.x = element_text(face = \"bold\", size = 12, margin = margin(t = 10)),\n      plot.background = element_rect(fill = \"white\", color = NA),\n      panel.background = element_rect(fill = \"gray98\", color = NA)\n    )\n}\n\n# Plot top items colored by gender (side-by-side bars)\nplot_top_items_by_gender <- function(data, n_items) {\n  \n  gender_colors <- c(\"girl\" = \"#C06C84\", \"boy\" = \"#0D677C\")\n  \n  # Get total participants per gender\n  totals <- data |>\n    group_by(gender_clean) |>\n    summarize(total = n_distinct(participant_id), .groups = \"drop\")\n  \n  # Calculate proportions by gender\n  summary_by_gender <- data |>\n    group_by(clean_item_name, gender_clean) |>\n    summarize(count = n_distinct(participant_id), .groups = \"drop\") |>\n    left_join(totals, by = \"gender_clean\") |>\n    mutate(percent = count / total)\n  \n  # Get top N items overall (regardless of gender)\n  top_items <- data |>\n    count_by_item() |>\n    slice_max(percent, n = n_items) |>\n    pull(clean_item_name)\n  \n  # Filter to just those top items\n  plot_data <- summary_by_gender |>\n    filter(clean_item_name %in% top_items)\n  \n  # Create plot\n  ggplot(plot_data, aes(x = reorder(clean_item_name, percent), y = percent, fill = gender_clean)) +\n    geom_col(position = \"dodge\", width = 0.7, alpha = 0.9) +\n    coord_flip() +\n    scale_fill_manual(values = gender_colors, name = \"Gender\") +\n    labs(\n      x = NULL,\n      y = \"Proportion of Participants\",\n      title = \"Top Collected Items by Gender\"\n    ) +\n    scale_y_continuous(\n      labels = scales::percent_format(accuracy = 1),\n      expand = expansion(mult = c(0, 0.05))\n    ) +\n    theme_minimal(base_size = 14) +\n    theme(\n      legend.position = \"bottom\",\n      legend.title = element_text(face = \"bold\", size = 16),\n      legend.text = element_text(size = 11),\n      plot.title = element_text(face = \"bold\", size = 16, hjust = 0.5, margin = margin(b = 15)),\n      panel.grid.major.y = element_blank(),\n      panel.grid.minor = element_blank(),\n      panel.grid.major.x = element_line(color = \"gray90\"),\n      axis.text.y = element_text(size = 12, color = \"gray20\"),\n      axis.text.x = element_text(size = 11),\n      axis.title.x = element_text(face = \"bold\", size = 12, margin = margin(t = 10)),\n      plot.background = element_rect(fill = \"white\", color = NA),\n      panel.background = element_rect(fill = \"gray98\", color = NA)\n    )\n}\n\n# ============================================================================\n# TOP ITEMS TABLE - Functions for top_items_table.R\n# ============================================================================\n\n# Compute top items by gender with rank, count, and percent\ncompute_top_items_by_gender <- function(data, n_items) {\n  data |>\n    group_by(gender_clean) |>\n    mutate(total = n_distinct(participant_id)) |>\n    group_by(gender_clean, clean_item_name, total) |>\n    summarize(count = n_distinct(participant_id), .groups = \"drop\") |>\n    mutate(percent = count / total) |>\n    group_by(gender_clean) |>\n    slice_max(order_by = count, n = n_items, with_ties = FALSE) |>\n    arrange(gender_clean, desc(count)) |>\n    group_by(gender_clean) |>\n    mutate(rank = row_number()) |>\n    ungroup()\n}\n\n# Create reactable for single gender\ncreate_top_items_table <- function(data, color) {\n  reactable(\n    data |> select(rank, clean_item_name, count, percent),\n    columns = list(\n      rank = colDef(\n        name = \"Rank\",\n        width = 60,\n        style = list(fontWeight = \"bold\")\n      ),\n      clean_item_name = colDef(\n        name = \"Item\",\n        minWidth = 150\n      ),\n      count = colDef(\n        name = \"Count\",\n        width = 80,\n        style = function(value) {\n          list(fontWeight = \"600\", color = color)\n        }\n      ),\n      percent = colDef(\n        name = \"Percent\",\n        width = 100,\n        format = colFormat(percent = TRUE, digits = 1),\n        style = function(value) {\n          list(\n            background = paste0(color, \"20\"),\n            borderLeft = paste0(\"4px solid \", color)\n          )\n        }\n      )\n    ),\n    defaultPageSize = 20,\n    striped = TRUE,\n    highlight = TRUE,\n    bordered = TRUE,\n    style = list(fontSize = \"14px\")\n  )\n}\n\n# Create combined table with both genders side-by-side\ncreate_combined_table <- function(data) {\n  \n  # Pivot to wide format\n  wide_data <- data |>\n    select(rank, gender_clean, clean_item_name, count, percent) |>\n    pivot_wider(\n      names_from = gender_clean,\n      values_from = c(clean_item_name, count, percent),\n      names_glue = \"{gender_clean}_{.value}\"\n    ) |>\n    select(\n      rank,\n      boy_clean_item_name, boy_count, boy_percent,\n      girl_clean_item_name, girl_count, girl_percent\n    )\n  \n  reactable(\n    wide_data,\n    columns = list(\n      rank = colDef(\n        name = \"Rank\",\n        width = 60,\n        style = list(fontWeight = \"bold\", textAlign = \"center\")\n      ),\n      boy_clean_item_name = colDef(\n        name = \"Item\",\n        minWidth = 150,\n        header = function() {\n          div(style = \"color: #0D677C; font-weight: bold;\", \"Boys - Item\")\n        }\n      ),\n      boy_count = colDef(\n        name = \"Count\",\n        width = 80,\n        style = list(color = \"#0D677C\", fontWeight = \"600\"),\n        header = function() {\n          div(style = \"color: #0D677C; font-weight: bold;\", \"Count\")\n        }\n      ),\n      boy_percent = colDef(\n        name = \"Percent\",\n        width = 100,\n        format = colFormat(percent = TRUE, digits = 1),\n        style = function(value) {\n          list(\n            background = \"#0D677C20\",\n            borderLeft = \"4px solid #0D677C\"\n          )\n        },\n        header = function() {\n          div(style = \"color: #0D677C; font-weight: bold;\", \"Percent\")\n        }\n      ),\n      girl_clean_item_name = colDef(\n        name = \"Item\",\n        minWidth = 150,\n        header = function() {\n          div(style = \"color: #C06C84; font-weight: bold;\", \"Girls - Item\")\n        }\n      ),\n      girl_count = colDef(\n        name = \"Count\",\n        width = 80,\n        style = list(color = \"#C06C84\", fontWeight = \"600\"),\n        header = function() {\n          div(style = \"color: #C06C84; font-weight: bold;\", \"Count\")\n        }\n      ),\n      girl_percent = colDef(\n        name = \"Percent\",\n        width = 100,\n        format = colFormat(percent = TRUE, digits = 1),\n        style = function(value) {\n          list(\n            background = \"#C06C8420\",\n            borderLeft = \"4px solid #C06C84\"\n          )\n        },\n        header = function() {\n          div(style = \"color: #C06C84; font-weight: bold;\", \"Percent\")\n        }\n      )\n    ),\n    columnGroups = list(\n      colGroup(name = \"Boys\", columns = c(\"boy_clean_item_name\", \"boy_count\", \"boy_percent\"),\n               headerStyle = list(background = \"#0D677C20\", fontWeight = \"bold\")),\n      colGroup(name = \"Girls\", columns = c(\"girl_clean_item_name\", \"girl_count\", \"girl_percent\"),\n               headerStyle = list(background = \"#C06C8420\", fontWeight = \"bold\"))\n    ),\n    defaultPageSize = 20,\n    striped = TRUE,\n    highlight = TRUE,\n    bordered = TRUE,\n    style = list(fontSize = \"14px\")\n  )\n}\n\n# ============================================================================\n# AGE COMPARISON - Functions for age_comparison.R\n# ============================================================================\n\n# Compute age trends for multiple items\ncompute_age_trends_multi <- function(filtered_data, full_data, items, genders, age_range) {\n  # Get total participants per age and gender\n  totals <- full_data |>\n    filter(\n      gender_clean %in% genders,\n      age_num >= age_range[1],\n      age_num <= age_range[2]\n    ) |>\n    group_by(age_num, gender_clean) |>\n    summarize(total = n_distinct(participant_id), .groups = \"drop\")\n  \n  # Calculate proportions for each item\n  filtered_data |>\n    group_by(clean_item_name, age_num, gender_clean) |>\n    summarize(count = n_distinct(participant_id), .groups = \"drop\") |>\n    left_join(totals, by = c(\"age_num\", \"gender_clean\")) |>\n    mutate(percent = count / total) |>\n    filter(!is.na(percent))\n}\n\n# Compute age trends with combined gender option\ncompute_age_trends_combined <- function(filtered_data, full_data, items, age_range) {\n  # Get total participants per age (combining both genders)\n  totals <- full_data |>\n    filter(\n      age_num >= age_range[1],\n      age_num <= age_range[2]\n    ) |>\n    group_by(age_num) |>\n    summarize(total = n_distinct(participant_id), .groups = \"drop\")\n  \n  # Calculate proportions for each item (combining both genders)\n  filtered_data |>\n    group_by(clean_item_name, age_num) |>\n    summarize(count = n_distinct(participant_id), .groups = \"drop\") |>\n    left_join(totals, by = \"age_num\") |>\n    mutate(\n      percent = count / total,\n      gender_clean = \"combined\"  # Add a gender column for consistency\n    ) |>\n    filter(!is.na(percent))\n}\n\n# Enhanced age trend plotting\nplot_age_trends_enhanced <- function(df, view_mode, show_points, gender_mode) {\n  gender_colors <- c(\"girl\" = \"#C06C84\", \"boy\" = \"#0D677C\", \"combined\" = \"#4A90E2\")\n  item_colors <- c(\"#2A7FFF\", \"#FF6B6B\", \"#4ECDC4\", \"#FFD93D\", \"#95E1D3\", \"#F38181\")\n  \n  # Determine if we're showing gender separation\n  show_gender <- gender_mode == \"both_separate\"\n  \n  # Base plot setup\n  if (view_mode == \"together\") {\n    # All items on one plot\n    if (show_gender) {\n      # Show different colors for each item, different line types for gender\n      p <- ggplot(df, aes(x = age_num, y = percent, \n                          color = clean_item_name, \n                          linetype = gender_clean, \n                          group = interaction(clean_item_name, gender_clean)))\n    } else {\n      # Just show different colors for each item\n      p <- ggplot(df, aes(x = age_num, y = percent, \n                          color = clean_item_name, \n                          group = clean_item_name))\n    }\n  } else {\n    # Separate panel for each item (facet_item)\n    if (show_gender) {\n      # Within each item panel, show boy/girl lines\n      p <- ggplot(df, aes(x = age_num, y = percent, \n                          color = gender_clean, \n                          group = gender_clean))\n    } else {\n      # Single line per item panel - color by gender_clean which will be boy, girl, or combined\n      p <- ggplot(df, aes(x = age_num, y = percent, \n                          color = gender_clean, \n                          group = 1))\n    }\n  }\n  \n  # Add lines\n  p <- p + geom_line(size = 1, alpha = 0.8)\n  \n  # Add points if requested\n  if (show_points) {\n    p <- p + geom_point(size = 1 * 1.5, alpha = 0.7)\n  }\n  \n  # Apply color scales\n  if (view_mode == \"together\") {\n    # Color by item\n    p <- p + scale_color_manual(values = item_colors, name = \"Item\")\n    if (show_gender) {\n      p <- p + scale_linetype_manual(values = c(\"boy\" = \"solid\", \"girl\" = \"dashed\"), \n                                     name = \"Gender\")\n    }\n  } else {\n    # facet_item mode - always color by gender (boy, girl, or combined)\n    p <- p + scale_color_manual(values = gender_colors, name = \"Gender\", guide = \"none\")\n  }\n  \n  # Add facets if needed\n  if (view_mode == \"facet_item\") {\n    p <- p + facet_wrap(~clean_item_name, ncol = 2)\n  }\n  \n  # Theme and labels\n  p <- p +\n    labs(\n      title = \"Age Trends Comparison\",\n      x = \"Age\",\n      y = \"Proportion of Participants\"\n    ) +\n    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +\n    scale_x_continuous(breaks = seq(0, 20, 2)) +\n    theme_minimal(base_size = 14) +\n    theme(\n      plot.title = element_text(face = \"bold\", size = 18, hjust = 0.5, margin = margin(b = 15)),\n      legend.position = \"bottom\",\n      legend.title = element_text(face = \"bold\", size = 12),\n      legend.text = element_text(size = 11),\n      panel.grid.minor = element_blank(),\n      panel.grid.major = element_line(color = \"gray90\"),\n      plot.background = element_rect(fill = \"white\", color = NA),\n      panel.background = element_rect(fill = \"gray98\", color = NA),\n      strip.text = element_text(face = \"bold\", size = 12),\n      strip.background = element_rect(fill = \"gray90\", color = NA)\n    )\n  \n  return(p)\n}\n\n# Compute summary statistics for trends\ncompute_trend_summary <- function(df, gender_mode) {\n  if (gender_mode == \"both_combined\") {\n    # Don't show gender column when combined\n    df |>\n      group_by(clean_item_name) |>\n      summarize(\n        `Min Age` = min(age_num, na.rm = TRUE),\n        `Max Age` = max(age_num, na.rm = TRUE),\n        `Avg Proportion` = scales::percent(mean(percent, na.rm = TRUE), accuracy = 0.1),\n        `Peak Age` = age_num[which.max(percent)],\n        `Peak Proportion` = scales::percent(max(percent, na.rm = TRUE), accuracy = 0.1),\n        `Sample Size` = sum(count, na.rm = TRUE),\n        .groups = \"drop\"\n      ) |>\n      rename(Item = clean_item_name)\n  } else {\n    # Show gender column when separate or single gender\n    df |>\n      group_by(clean_item_name, gender_clean) |>\n      summarize(\n        `Min Age` = min(age_num, na.rm = TRUE),\n        `Max Age` = max(age_num, na.rm = TRUE),\n        `Avg Proportion` = scales::percent(mean(percent, na.rm = TRUE), accuracy = 0.1),\n        `Peak Age` = age_num[which.max(percent)],\n        `Peak Proportion` = scales::percent(max(percent, na.rm = TRUE), accuracy = 0.1),\n        `Sample Size` = sum(count, na.rm = TRUE),\n        .groups = \"drop\"\n      ) |>\n      rename(Item = clean_item_name, Gender = gender_clean)\n  }\n}\n\n# ============================================================================\n# ALIGNMENT - Functions for alignment.R\n# ============================================================================\n\n# Compute gender proportions for alignment visualization\ncompute_gender_proportions <- function(data) {\n  data |>\n    group_by(gender_clean, clean_item_name) |>\n    summarize(count = n(), .groups = \"drop\") |>\n    group_by(gender_clean) |>\n    mutate(proportion = count / sum(count)) |>\n    ungroup()\n}\n\n# Get top N items for each gender\nget_top_items_by_gender <- function(df, n) {\n  df |>\n    group_by(gender_clean) |>\n    slice_max(order_by = proportion, n = n, with_ties = FALSE) |>\n    ungroup()\n}\n\n# Join boys and girls data to find shared items\njoin_shared_items <- function(boys_df, girls_df) {\n  inner_join(\n    boys_df |> select(clean_item_name, prop_boy = proportion),\n    girls_df |> select(clean_item_name, prop_girl = proportion),\n    by = \"clean_item_name\"\n  )\n}\n\n# Count total participants by gender\ncount_participants_by_gender <- function(data) {\n  data |>\n    group_by(gender_clean) |>\n    summarize(total = n_distinct(participant_id), .groups = \"drop\")\n}\n\n# Rank-ordered alignment plot with sample sizes\nplot_alignment_ranked <- function(boys_df, girls_df, shared_df, n_boys, n_girls) {\n  \n  # Add ranks (rank 1 = highest proportion)\n  boys_df <- boys_df |>\n    arrange(desc(proportion)) |>\n    mutate(rank = row_number())\n  \n  girls_df <- girls_df |>\n    arrange(desc(proportion)) |>\n    mutate(rank = row_number())\n  \n  # Update shared items with ranks\n  shared_df <- shared_df |>\n    left_join(boys_df |> select(clean_item_name, boy_rank = rank), by = \"clean_item_name\") |>\n    left_join(girls_df |> select(clean_item_name, girl_rank = rank), by = \"clean_item_name\")\n  \n  # Create plot\n  ggplot() +\n    # Connecting lines for shared items\n    geom_segment(\n      data = shared_df,\n      aes(x = 1, xend = 2, y = boy_rank, yend = girl_rank),\n      color = \"gray60\",\n      alpha = 0.5,\n      size = 0.8\n    ) +\n    # Boys points (size based on proportion)\n    geom_point(\n      data = boys_df,\n      aes(x = 1, y = rank, size = proportion),\n      color = \"#0D677C\",\n      alpha = 0.8\n    ) +\n    # Boys labels (aligned on left)\n    geom_text(\n      data = boys_df,\n      aes(x = 0.92, y = rank, \n          label = paste0(rank, \". \", clean_item_name, \" (\", round(proportion*100, 1), \"%)\")),\n      hjust = 1,\n      size = 3.5,\n      color = \"#0D677C\"\n    ) +\n    # Girls points (size based on proportion)\n    geom_point(\n      data = girls_df,\n      aes(x = 2, y = rank, size = proportion),\n      color = \"#C06C84\",\n      alpha = 0.8\n    ) +\n    # Girls labels (aligned on right)\n    geom_text(\n      data = girls_df,\n      aes(x = 2.08, y = rank, \n          label = paste0(rank, \". \", clean_item_name, \" (\", round(proportion*100, 1), \"%)\")),\n      hjust = 0,\n      size = 3.5,\n      color = \"#C06C84\"\n    ) +\n    # Sample sizes at bottom\n    annotate(\n      \"text\",\n      x = 1,\n      y = max(c(boys_df$rank, girls_df$rank)) + 1.5,\n      label = paste0(\"n = \", n_boys),\n      size = 5,\n      fontface = \"bold\",\n      color = \"#0D677C\"\n    ) +\n    annotate(\n      \"text\",\n      x = 2,\n      y = max(c(boys_df$rank, girls_df$rank)) + 1.5,\n      label = paste0(\"n = \", n_girls),\n      size = 5,\n      fontface = \"bold\",\n      color = \"#C06C84\"\n    ) +\n    scale_x_continuous(\n      limits = c(0.2, 2.8),\n      breaks = c(1, 2),\n      labels = c(\"Boys\", \"Girls\")\n    ) +\n    scale_y_reverse(expand = expansion(mult = c(0.02, 0.08))) +  # Reverse so rank 1 is at top\n    scale_size_continuous(range = c(4, 12), name = \"Proportion\") +\n    labs(\n      x = NULL,\n      y = NULL,\n      title = \"Top Items by Gender (Rank Ordered)\"\n    ) +\n    theme_minimal(base_size = 14) +\n    theme(\n      axis.text.y = element_blank(),\n      panel.grid = element_blank(),\n      legend.position = \"bottom\",\n      plot.title = element_text(face = \"bold\", size = 16, hjust = 0.5, margin = margin(b = 20)),\n      axis.text.x = element_text(face = \"bold\", size = 14, color = \"gray30\"),\n      plot.background = element_rect(fill = \"white\", color = NA),\n      panel.background = element_rect(fill = \"gray98\", color = NA)\n    )\n}\n\n# ============================================================================\n# INTEREST - Functions for interest.R (freelist data)\n# ============================================================================\n\n# Get selection choices based on type\nget_selection_choices <- function(data, selection_type) {\n  if (selection_type == \"item\") {\n    data |>\n      filter(!is.na(cleaned_name)) |>\n      pull(cleaned_name) |>\n      unique() |>\n      sort()\n  } else if (selection_type == \"category\") {\n    data |>\n      filter(!is.na(category)) |>\n      pull(category) |>\n      unique() |>\n      sort()\n  } else if (selection_type == \"object_type\") {\n    data |>\n      filter(!is.na(object_type)) |>\n      pull(object_type) |>\n      unique() |>\n      sort()\n  } else if (selection_type == \"taxonomic_content\") {\n    data |>\n      filter(!is.na(taxonomic_content), taxonomic_content != \"NA\") |>\n      pull(taxonomic_content) |>\n      unique() |>\n      sort()\n  } else if (selection_type == \"animal_related\") {\n    c(\"Yes\" = \"y\", \"No\" = \"\")\n  } else if (selection_type == \"fiction_related\") {\n    c(\"Yes\" = \"y\", \"No\" = \"\")\n  }\n}\n\n# Get label for selection dropdown\nget_selection_label <- function(selection_type) {\n  labels <- c(\n    \"item\" = \"Select Item:\",\n    \"category\" = \"Select Category:\",\n    \"object_type\" = \"Select Object Type:\",\n    \"taxonomic_content\" = \"Select Taxonomic Content:\",\n    \"animal_related\" = \"Animal-Related:\",\n    \"fiction_related\" = \"Fiction-Related:\"\n  )\n  labels[selection_type]\n}\n\n# Get items in a group\nget_items_in_group <- function(data, selection_type, selection_value) {\n  if (selection_type == \"category\") {\n    data |>\n      filter(category == selection_value) |>\n      pull(cleaned_name) |>\n      unique() |>\n      sort()\n  } else if (selection_type == \"object_type\") {\n    data |>\n      filter(object_type == selection_value) |>\n      pull(cleaned_name) |>\n      unique() |>\n      sort()\n  } else if (selection_type == \"taxonomic_content\") {\n    data |>\n      filter(taxonomic_content == selection_value) |>\n      pull(cleaned_name) |>\n      unique() |>\n      sort()\n  } else if (selection_type == \"animal_related\") {\n    data |>\n      filter(`animal-related` == selection_value) |>\n      pull(cleaned_name) |>\n      unique() |>\n      sort()\n  } else if (selection_type == \"fiction_related\") {\n    data |>\n      filter(`fiction-related` == selection_value) |>\n      pull(cleaned_name) |>\n      unique() |>\n      sort()\n  }\n}\n\n# Compute interest summary for individual item\ncompute_interest_summary_item <- function(data, item_name, genders, age_range, gender_mode) {\n  \n  filtered <- data |>\n    filter(\n      cleaned_name == item_name,\n      gender_clean %in% genders,\n      age_num >= age_range[1],\n      age_num <= age_range[2]\n    )\n  \n  if (gender_mode == \"both_separate\") {\n    # Show by gender - count DISTINCT participants per gender\n    summary_data <- filtered |>\n      group_by(gender_clean) |>\n      summarise(\n        Learning = mean(interest_learning, na.rm = TRUE),\n        Curious = mean(interest_curious, na.rm = TRUE),\n        Talking = mean(interest_talking, na.rm = TRUE),\n        Playing = mean(interest_playing, na.rm = TRUE),\n        n = n_distinct(response_id),\n        .groups = \"drop\"\n      ) |>\n      pivot_longer(\n        cols = c(Learning, Curious, Talking, Playing),\n        names_to = \"dimension\",\n        values_to = \"mean_score\"\n      )\n    \n    # Add sample size information as an attribute\n    n_by_gender <- filtered |>\n      group_by(gender_clean) |>\n      summarise(n = n_distinct(response_id), .groups = \"drop\")\n    \n    attr(summary_data, \"sample_sizes\") <- n_by_gender\n    \n    return(summary_data)\n  } else {\n    # Combined - count total distinct participants\n    summary_data <- filtered |>\n      summarise(\n        Learning = mean(interest_learning, na.rm = TRUE),\n        Curious = mean(interest_curious, na.rm = TRUE),\n        Talking = mean(interest_talking, na.rm = TRUE),\n        Playing = mean(interest_playing, na.rm = TRUE),\n        n = n_distinct(response_id)\n      ) |>\n      pivot_longer(\n        cols = c(Learning, Curious, Talking, Playing),\n        names_to = \"dimension\",\n        values_to = \"mean_score\"\n      )\n    \n    # Add sample size as an attribute\n    attr(summary_data, \"sample_size\") <- filtered |> \n      summarise(n = n_distinct(response_id)) |> \n      pull(n)\n    \n    return(summary_data)\n  }\n}\n\n# Compute interest summary for grouped items\ncompute_interest_summary_grouped <- function(data, selection_type, selection_value, \n                                             genders, age_range, gender_mode) {\n  \n  # Filter by the dictionary field\n  if (selection_type == \"category\") {\n    filtered <- data |> filter(category == selection_value)\n  } else if (selection_type == \"object_type\") {\n    filtered <- data |> filter(object_type == selection_value)\n  } else if (selection_type == \"taxonomic_content\") {\n    filtered <- data |> filter(taxonomic_content == selection_value)\n  } else if (selection_type == \"animal_related\") {\n    filtered <- data |> filter(`animal-related` == selection_value)\n  } else if (selection_type == \"fiction_related\") {\n    filtered <- data |> filter(`fiction-related` == selection_value)\n  }\n  \n  # Further filter by gender and age\n  filtered <- filtered |>\n    filter(\n      gender_clean %in% genders,\n      age_num >= age_range[1],\n      age_num <= age_range[2]\n    )\n  \n  if (gender_mode == \"both_separate\") {\n    # Show by gender - count DISTINCT participants per gender\n    summary_data <- filtered |>\n      group_by(gender_clean) |>\n      summarise(\n        Learning = mean(interest_learning, na.rm = TRUE),\n        Curious = mean(interest_curious, na.rm = TRUE),\n        Talking = mean(interest_talking, na.rm = TRUE),\n        Playing = mean(interest_playing, na.rm = TRUE),\n        n = n_distinct(response_id),\n        .groups = \"drop\"\n      ) |>\n      pivot_longer(\n        cols = c(Learning, Curious, Talking, Playing),\n        names_to = \"dimension\",\n        values_to = \"mean_score\"\n      )\n    \n    # Add sample size information as an attribute\n    n_by_gender <- filtered |>\n      group_by(gender_clean) |>\n      summarise(n = n_distinct(response_id), .groups = \"drop\")\n    \n    attr(summary_data, \"sample_sizes\") <- n_by_gender\n    \n    return(summary_data)\n  } else {\n    # Combined - count total distinct participants\n    summary_data <- filtered |>\n      summarise(\n        Learning = mean(interest_learning, na.rm = TRUE),\n        Curious = mean(interest_curious, na.rm = TRUE),\n        Talking = mean(interest_talking, na.rm = TRUE),\n        Playing = mean(interest_playing, na.rm = TRUE),\n        n = n_distinct(response_id)\n      ) |>\n      pivot_longer(\n        cols = c(Learning, Curious, Talking, Playing),\n        names_to = \"dimension\",\n        values_to = \"mean_score\"\n      )\n    \n    # Add sample size as an attribute\n    attr(summary_data, \"sample_size\") <- filtered |> \n      summarise(n = n_distinct(response_id)) |> \n      pull(n)\n    \n    return(summary_data)\n  }\n}\n\n# Enhanced plot function\nplot_interest_profile_enhanced <- function(summary_df, selection_name, \n                                           selection_type, gender_mode) {\n  \n  gender_colors <- c(\"girl\" = \"#C06C84\", \"boy\" = \"#0D677C\")\n  \n  # Create title based on selection type\n  title_text <- if (selection_type == \"item\") {\n    paste(\"Interest Profile for:\", selection_name)\n  } else if (selection_type == \"category\") {\n    paste(\"Interest Profile for Category:\", selection_name)\n  } else if (selection_type == \"object_type\") {\n    paste(\"Interest Profile for Object Type:\", selection_name)\n  } else if (selection_type == \"taxonomic_content\") {\n    paste(\"Interest Profile for Taxonomic Content:\", selection_name)\n  } else if (selection_type == \"animal_related\") {\n    paste(\"Interest Profile for Animal-Related Items:\", ifelse(selection_name == \"y\", \"Yes\", \"No\"))\n  } else if (selection_type == \"fiction_related\") {\n    paste(\"Interest Profile for Fiction-Related Items:\", ifelse(selection_name == \"y\", \"Yes\", \"No\"))\n  }\n  \n  # Create caption with sample size information\n  caption_text <- NULL\n  if (gender_mode == \"both_separate\") {\n    # Get sample sizes from attribute\n    sample_sizes <- attr(summary_df, \"sample_sizes\")\n    if (!is.null(sample_sizes)) {\n      boy_n <- sample_sizes |> filter(gender_clean == \"boy\") |> pull(n)\n      girl_n <- sample_sizes |> filter(gender_clean == \"girl\") |> pull(n)\n      \n      if (length(boy_n) > 0 && length(girl_n) > 0) {\n        caption_text <- paste0(\"Boys: n=\", boy_n, \" | Girls: n=\", girl_n)\n      } else if (length(boy_n) > 0) {\n        caption_text <- paste0(\"Boys: n=\", boy_n)\n      } else if (length(girl_n) > 0) {\n        caption_text <- paste0(\"Girls: n=\", girl_n)\n      }\n    }\n  } else {\n    # Get combined sample size from attribute\n    sample_size <- attr(summary_df, \"sample_size\")\n    if (!is.null(sample_size)) {\n      caption_text <- paste0(\"n=\", sample_size)\n    }\n  }\n  \n  # Create plot\n  if (gender_mode == \"both_separate\" && \"gender_clean\" %in% names(summary_df)) {\n    # Grouped bars for boys and girls\n    p <- ggplot(summary_df, aes(x = dimension, y = mean_score, fill = gender_clean)) +\n      geom_col(position = \"dodge\", width = 0.7, alpha = 0.9) +\n      scale_fill_manual(values = gender_colors, name = \"Gender\") +\n      scale_y_continuous(limits = c(0, 7), breaks = 0:7, expand = expansion(mult = c(0, 0.05))) +\n      labs(\n        x = NULL,\n        y = \"Mean Agreement (1–7)\",\n        title = title_text,\n        caption = caption_text\n      ) +\n      theme_minimal(base_size = 14) +\n      theme(\n        legend.position = \"bottom\",\n        plot.title = element_text(face = \"bold\", size = 14, hjust = 0.5),\n        plot.caption = element_text(size = 13, hjust = 0.5, face = \"bold\", color = \"gray20\", margin = margin(t = 10)),\n        panel.grid.major.x = element_blank(),\n        panel.grid.minor = element_blank(),\n        axis.text.x = element_text(size = 12),\n        plot.background = element_rect(fill = \"white\", color = NA),\n        panel.background = element_rect(fill = \"gray98\", color = NA)\n      )\n  } else {\n    # Single bars - determine color based on gender_mode\n    bar_color <- if (gender_mode == \"boy\") {\n      \"#0D677C\"  # Boy color\n    } else if (gender_mode == \"girl\") {\n      \"#C06C84\"  # Girl color\n    } else {\n      \"#4A90E2\"  # Combined color (both_combined)\n    }\n    \n    p <- ggplot(summary_df, aes(x = dimension, y = mean_score)) +\n      geom_col(fill = bar_color, width = 0.6, alpha = 0.9) +\n      scale_y_continuous(limits = c(0, 7), breaks = 0:7, expand = expansion(mult = c(0, 0.05))) +\n      labs(\n        x = NULL,\n        y = \"Mean Agreement (1–7)\",\n        title = title_text,\n        caption = caption_text\n      ) +\n      theme_minimal(base_size = 14) +\n      theme(\n        plot.title = element_text(face = \"bold\", size = 14, hjust = 0.5),\n        plot.caption = element_text(size = 13, hjust = 0.5, face = \"bold\", color = \"gray20\", margin = margin(t = 10)),\n        panel.grid.major.x = element_blank(),\n        panel.grid.minor = element_blank(),\n        axis.text.x = element_text(size = 12),\n        plot.background = element_rect(fill = \"white\", color = NA),\n        panel.background = element_rect(fill = \"gray98\", color = NA)\n      )\n  }\n  \n  return(p)\n}","type":"text"},{"name":"R/interest.R","content":"# ============================================================================\n# FILE: R/interest.R\n# PURPOSE: Interest profiles for freelist collections with dictionary grouping\n# DESCRIPTION: Line plot showing mean interest ratings with options to view\n#              by individual items or grouped by dictionary categories\n# ============================================================================\n\ninterest_ui <- function(id) {\n  ns <- NS(id)\n  \n  tabPanel(\n    \"Interest Profiles\",\n    sidebarLayout(\n      sidebarPanel(\n        radioButtons(\n          ns(\"selection_type\"),\n          \"View By:\",\n          choices = c(\n            \"Individual Item\" = \"item\",\n            \"Category\" = \"category\",\n            \"Object Type\" = \"object_type\",\n            \"Taxonomic Content\" = \"taxonomic_content\",\n            \"Animal-Related\" = \"animal_related\",\n            \"Fiction-Related\" = \"fiction_related\"\n          ),\n          selected = \"item\"\n        ),\n        \n        selectInput(\n          ns(\"selection\"),\n          \"Select:\",\n          choices = NULL\n        ),\n        \n        hr(),\n        \n        sliderInput(\n          ns(\"age_range\"),\n          \"Age Range:\",\n          min = 1,\n          max = 18,\n          value = c(1, 18)\n        ),\n        \n        selectInput(\n          ns(\"gender_filter\"),\n          \"Select Gender:\",\n          choices = c(\n            \"Boys Only\" = \"boy\",\n            \"Girls Only\" = \"girl\",\n            \"Boys & Girls (Separated)\" = \"both_separate\",\n            \"Boys & Girls (Combined)\" = \"both_combined\"\n          ),\n          selected = \"both_combined\"\n        ),\n        \n        hr(),\n        \n        textOutput(ns(\"sample_size\"))\n      ),\n      mainPanel(\n        plotOutput(ns(\"interest_plot\"), height = \"400px\"),\n        \n        wellPanel(\n          style = \"background-color: #f8f9fa; border: 1px solid #dee2e6; margin-top: 20px;\",\n          h4(\"Items Included\", style = \"font-weight: bold; color: #495057;\"),\n          textOutput(ns(\"items_included\"))\n        )\n      )\n    )\n  )\n}\n\ninterest_server <- function(id, freelist_long_data) {\n  moduleServer(id, function(input, output, session) {\n    \n    # Update age range based on data\n    observe({\n      updateSliderInput(\n        session,\n        \"age_range\",\n        min = min(freelist_long_data$age_num, na.rm = TRUE),\n        max = max(freelist_long_data$age_num, na.rm = TRUE),\n        value = c(min(freelist_long_data$age_num, na.rm = TRUE), \n                  max(freelist_long_data$age_num, na.rm = TRUE))\n      )\n    })\n    \n    # Update selection dropdown based on selection type\n    observe({\n      choices <- get_selection_choices(freelist_long_data, input$selection_type)\n      \n      updateSelectInput(\n        session,\n        \"selection\",\n        label = get_selection_label(input$selection_type),\n        choices = choices,\n        selected = choices[1]\n      )\n    })\n    \n    # Compute summary based on selection type\n    summary <- reactive({\n      req(input$selection)\n      \n      gender_info <- parse_gender_selection(input$gender_filter)\n      \n      if (input$selection_type == \"item\") {\n        # Individual item\n        compute_interest_summary_item(\n          freelist_long_data,\n          input$selection,\n          gender_info$genders,\n          input$age_range,\n          input$gender_filter\n        )\n      } else {\n        # Grouped by dictionary field\n        compute_interest_summary_grouped(\n          freelist_long_data,\n          input$selection_type,\n          input$selection,\n          gender_info$genders,\n          input$age_range,\n          input$gender_filter\n        )\n      }\n    })\n    \n    # Get items included in selection\n    items_list <- reactive({\n      req(input$selection)\n      \n      if (input$selection_type == \"item\") {\n        input$selection\n      } else {\n        get_items_in_group(freelist_long_data, input$selection_type, input$selection)\n      }\n    })\n    \n    # Display items included\n    output$items_included <- renderText({\n      items <- items_list()\n      if (length(items) == 1) {\n        paste0(\"Showing: \", items)\n      } else {\n        paste0(\"Showing \", length(items), \" items: \", paste(items, collapse = \", \"))\n      }\n    })\n    \n    # Render plot\n    output$interest_plot <- renderPlot({\n      req(nrow(summary()) > 0)\n      \n      plot_interest_profile_enhanced(\n        summary(),\n        input$selection,\n        input$selection_type,\n        input$gender_filter\n      )\n    })\n  })\n}","type":"text"},{"name":"R/top_items_proportion.R","content":"# ============================================================================\n# FILE: R/top_items_proportion.R\n# PURPOSE: Bar chart showing proportion of participants with top items\n# DESCRIPTION: Visualize most commonly collected items with filters for \n#              gender and age\n# ============================================================================\n\ntop_items_proportion_ui <- function(id) {\n  ns <- NS(id)\n  \n  tabPanel(\"Top Items\",\n           sidebarLayout(\n             sidebarPanel(\n               selectInput(\n                 ns(\"gender_filter\"),\n                 \"Select Gender:\",\n                 choices = c(\n                   \"Boys Only\" = \"boy\",\n                   \"Girls Only\" = \"girl\",\n                   \"Boys & Girls (Separated)\" = \"both_separate\",\n                   \"Boys & Girls (Combined)\" = \"both_combined\"\n                 ),\n                 selected = \"both_combined\"\n               ),\n               sliderInput(\n                 ns(\"top_n\"),\n                 \"Number of Top Items to Show:\",\n                 min = 5,\n                 max = 40,\n                 value = 10,\n                 step = 1\n               ),\n               sliderInput(\n                 ns(\"age_range\"),\n                 \"Age Range:\",\n                 min = 1,\n                 max = 100,\n                 value = c(1, 100),\n                 step = 1\n               )\n             ),\n             mainPanel(\n               plotOutput(ns(\"bar_plot\"), height = \"600px\")\n             )\n           ))\n}\n\ntop_items_proportion_server <- function(id, data) {\n  moduleServer(id, function(input, output, session) {\n    \n    observe({\n      min_age <- min(data$age_num, na.rm = TRUE)\n      max_age <- max(data$age_num, na.rm = TRUE)\n      updateSliderInput(\n        session,\n        \"age_range\",\n        min = min_age,\n        max = max_age,\n        value = c(min_age, max_age)\n      )\n    })\n    \n    filtered <- reactive({\n      # Determine which genders to include\n      genders <- if (input$gender_filter %in% c(\"boy\", \"girl\")) {\n        input$gender_filter\n      } else {\n        c(\"boy\", \"girl\")\n      }\n      \n      filter_checklist(data, genders, input$age_range)\n    })\n    \n    output$bar_plot <- renderPlot({\n      req(nrow(filtered()) > 0)\n      if (input$gender_filter == \"both_separate\") {\n        plot_top_items_by_gender(filtered(), input$top_n)\n      } else {\n        summary <- filtered() |> \n          count_by_item() |> \n          slice_max(percent, n = input$top_n)\n        title <- switch(\n          input$gender_filter,\n          \"boy\"  = \"Top Collected Items – Boys\",\n          \"girl\" = \"Top Collected Items – Girls\",\n          \"both_combined\" = \"Top Collected Items\"\n        )\n        color <- switch(\n          input$gender_filter,\n          \"boy\"  = \"#0D677C\",\n          \"girl\" = \"#C06C84\",\n          \"both_combined\" = \"#4A90E2\"\n        )\n        \n        plot_top_items(summary, title, color)\n      }\n    })\n  })\n}\n","type":"text"},{"name":"R/top_items_table.R","content":"# ============================================================================\n# FILE: R/top_items_table.R\n# PURPOSE: Interactive table showing top collected items by gender\n# DESCRIPTION: Sortable, filterable reactable displaying top items with \n#              side-by-side or combined view, showing rank, count, and percent\n# ============================================================================\n\ntop_items_table_ui <- function(id) {\n  ns <- NS(id)\n  \n  tabPanel(\"Top Items Table\",\n           sidebarLayout(\n             sidebarPanel(\n               selectInput(\n                 ns(\"gender_filter\"),\n                 \"Select Gender:\",\n                 choices = c(\n                   \"Boys Only\" = \"boy\",\n                   \"Girls Only\" = \"girl\",\n                   \"Boys & Girls (Separated)\" = \"both_separate\",\n                   \"Boys & Girls (Combined)\" = \"both_combined\"\n                 ),\n                 selected = \"both_combined\"\n               ),\n               sliderInput(\n                 ns(\"n_items\"),\n                 \"Number of Top Items to Show:\",\n                 min = 5,\n                 max = 40,\n                 value = 10,\n                 step = 5\n               ),\n               sliderInput(\n                 ns(\"age_range\"),\n                 \"Age Range:\",\n                 min = 1,\n                 max = 18,\n                 value = c(1, 18),\n                 step = 1\n               )\n             ),\n             mainPanel(\n               uiOutput(ns(\"table_output\"))\n             )\n           ))\n}\n\ntop_items_table_server <- function(id, data) {\n  moduleServer(id, function(input, output, session) {\n    \n    observe({\n      min_age <- min(data$age_num, na.rm = TRUE)\n      max_age <- max(data$age_num, na.rm = TRUE)\n      updateSliderInput(\n        session,\n        \"age_range\",\n        min = min_age,\n        max = max_age,\n        value = c(min_age, max_age)\n      )\n    })\n    \n    filtered_data <- reactive({\n      genders <- if (input$gender_filter %in% c(\"boy\", \"girl\")) {\n        input$gender_filter\n      } else {\n        c(\"boy\", \"girl\")\n      }\n      \n      data |>\n        filter(\n          gender_clean %in% genders,\n          age_num >= input$age_range[1],\n          age_num <= input$age_range[2]\n        )\n    })\n    \n    top_items_data <- reactive({\n      if (input$gender_filter == \"both_combined\") {\n        # Combined: ignore gender\n        filtered_data() |>\n          count_by_item() |>\n          slice_max(percent, n = input$n_items) |>\n          mutate(rank = row_number())\n      } else {\n        # By gender\n        compute_top_items_by_gender(filtered_data(), input$n_items)\n      }\n    })\n    \n    output$table_output <- renderUI({\n      ns <- session$ns\n      \n      if (input$gender_filter == \"both_separate\") {\n        # Side by side tables\n        boys_data <- top_items_data() |> filter(gender_clean == \"boy\")\n        girls_data <- top_items_data() |> filter(gender_clean == \"girl\")\n        \n        fluidRow(\n          column(\n            6,\n            h4(\"Boys\", style = \"color: #0D677C; text-align: center;\"),\n            reactableOutput(ns(\"boys_table\"))\n          ),\n          column(\n            6,\n            h4(\"Girls\", style = \"color: #C06C84; text-align: center;\"),\n            reactableOutput(ns(\"girls_table\"))\n          )\n        )\n      } else if (input$gender_filter == \"both_combined\") {\n        tagList(\n          h3(\n            \"Top Collected Items\",\n            style = \"text-align: center; margin-bottom: 10px; color: #4A90E2;\"\n          ),\n          reactableOutput(ns(\"single_table\"))\n        )\n        \n      } else if (input$gender_filter == \"boy\") {\n        tagList(\n          h3(\n            \"Top Collected Items – Boys\",\n            style = \"text-align: center; margin-bottom: 10px; color: #0D677C;\"\n          ),\n          reactableOutput(ns(\"single_table\"))\n        )\n        \n      } else if (input$gender_filter == \"girl\") {\n        tagList(\n          h3(\n            \"Top Colleted Items – Girls\",\n            style = \"text-align: center; margin-bottom: 10px; color: #C06C84;\"\n          ),\n          reactableOutput(ns(\"single_table\"))\n        )\n      }\n    })\n    \n    output$boys_table <- renderReactable({\n      boys_data <- top_items_data() |> filter(gender_clean == \"boy\")\n      create_top_items_table(boys_data, \"#0D677C\")\n    })\n    \n    output$girls_table <- renderReactable({\n      girls_data <- top_items_data() |> filter(gender_clean == \"girl\")\n      create_top_items_table(girls_data, \"#C06C84\")\n    })\n    \n    output$single_table <- renderReactable({\n      color <- if (input$gender_filter == \"boy\") \"#0D677C\" else if (input$gender_filter == \"girl\") \"#C06C84\" else \"#4A90E2\"\n      \n      if (input$gender_filter == \"both_combined\") {\n        reactable(\n          top_items_data() |> select(rank, clean_item_name, count, percent),\n          columns = list(\n            rank = colDef(name = \"Rank\", width = 60, style = list(fontWeight = \"bold\")),\n            clean_item_name = colDef(name = \"Item\", minWidth = 150),\n            count = colDef(name = \"Count\", width = 80, style = function(value) {\n              list(fontWeight = \"600\", color = color)\n            }),\n            percent = colDef(\n              name = \"Percent\",\n              width = 100,\n              format = colFormat(percent = TRUE, digits = 1),\n              style = function(value) {\n                list(background = paste0(color, \"20\"), borderLeft = paste0(\"4px solid \", color))\n              }\n            )\n          ),\n          defaultPageSize = 20,\n          striped = TRUE,\n          highlight = TRUE,\n          bordered = TRUE,\n          style = list(fontSize = \"14px\")\n        )\n      } else {\n        create_top_items_table(top_items_data(), color)\n      }\n    })\n  })\n}\n","type":"text"}]
